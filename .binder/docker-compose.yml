version: '3'

# you should not use this file directly, but rather via the targets in ../Makefile

# this service runs a jupyter notebook server with all of pymor's
# requirements installed and the src directory added to PYTHONPATH

# you should have a preset PYMOR_JUPYTER_TOKEN environment variable,
# then start with ```docker-compose up --build```
# and connect to the server at http://localhost:9180/?token=${PYMOR_JUPYTER_TOKEN}

# 3rd party libraries that need editing can be put in .binder/local_packages/
# These are "installed" at build time of the image and will be available
# via mount at container runtime

services:
  jupyter:
    depends_on:
      - pypi_mirror
    build:
        context: ../
        dockerfile: .binder/Dockerfile
        args:
            BASE: pymor/jupyter_py${DOCKER_BASE_PYTHON}:${CI_IMAGE_TAG}
            PYMOR_JUPYTER_TOKEN: "${PYMOR_JUPYTER_TOKEN}"
            NB_USER: "${USER}"
            NB_UID: 1000
            BUILD_ENV: dev

    ports:
        - 9180:8888
    volumes:
        - ./..:/pymor
        - ./local_packages:/pymor/local_packages
    restart: "no"
    environment:
      - NB_DIR
    entrypoint: /usr/local/bin/dev-entrypoint.bash
    # xsrf check disabled for docs viewing with chrome. Somewhat related issue: https://github.com/jupyterlab/jupyterlab/issues/6106
    # and see also https://bugs.chromium.org/p/chromium/issues/detail?id=455987
    command: >
        bash -c "jupyter notebook --ip 0.0.0.0 --no-browser --notebook-dir=$${NB_DIR} --NotebookApp.disable_check_xsrf=True"

  pytest:
    image: pymor/jupyter_py${DOCKER_BASE_PYTHON}:${CI_IMAGE_TAG}
    depends_on:
      - pypi_mirror
    environment:
      - CI_PROJECT_DIR=/src
    volumes:
        - ./..:/pymor
    restart: "no"
    command: "/pymor/.ci/gitlab/test_vanilla.bash"

  pypi_mirror:
    image: pymor/pypi-mirror_stable_py${DOCKER_BASE_PYTHON}:${PYPI_MIRROR_TAG}
    restart: "no"

  docs:
    image: pymor/jupyter_py${DOCKER_BASE_PYTHON}:${CI_IMAGE_TAG}
    depends_on:
      - pypi_mirror
    environment:
      - PYMOR_FORCE_JUPYTER=1
      - PYMOR_WITH_SPHINX=1
      - CI_PROJECT_DIR=/src
    volumes:
        - ./..:/pymor
    restart: "no"
    command: "/pymor/.ci/gitlab/test_docs.bash"
