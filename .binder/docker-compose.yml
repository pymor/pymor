version: '3'

# this service runs a jupyter notebook server with all of pymor's
# requirements installed and the src directory added to PYTHONPATH

# you should have a preset PYMOR_JUPYTER_TOKEN environment variable,
# then start with ```docker-compose up --build```
# and connect to the server at http://localhost:9180/?token=${PYMOR_JUPYTER_TOKEN}

services:
  jupyter:
    build:
        context: ../
        dockerfile: .binder/Dockerfile
        args:
            BASE: pymor/testing_py3.7:05486aa0fe225e7aac9cc32eb5bcbeb73339a500
            PYMOR_JUPYTER_TOKEN: "${PYMOR_JUPYTER_TOKEN}"
            NB_USER: "${USER}"
            NB_UID: 1000
            BUILD_ENV: dev

    ports:
        - 9180:8888
    volumes:
        - ./..:/pymor
    restart: "no"
    environment:
      - NB_DIR
    entrypoint: /usr/local/bin/dev-entrypoint.bash
    # xsrf check disabled for docs viewing with chrome. Somewhat related issue: https://github.com/jupyterlab/jupyterlab/issues/6106
    command: >
        bash -c "jupyter notebook --ip 0.0.0.0 --no-browser --notebook-dir=$${NB_DIR} --NotebookApp.disable_check_xsrf=True"

  pytest:
    image: pymor/testing_py3.7:05486aa0fe225e7aac9cc32eb5bcbeb73339a500
    environment:
      - PYMOR_PYTEST_MARKER=${PYMOR_PYTEST_MARKER}
      - CI_PROJECT_DIR=/src
    volumes:
        - ./..:/src
    restart: "no"
    command: "/src/.ci/gitlab/script.bash"

  docs:
    image: pymor/testing:3.7
    environment:
      - PYMOR_FORCE_JUPYTER=1
      - PYMOR_WITH_SPHINX=1
      - CI_PROJECT_DIR=/src
    volumes:
        - ./..:/src
    restart: "no"
    command: "/src/.ci/gitlab/test_docs.bash"