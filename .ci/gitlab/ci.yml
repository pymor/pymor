# THIS FILE IS AUTOGENERATED -- DO NOT EDIT #
#   Edit and Re-run .ci/gitlab/template.ci.py instead       #

stages:
  - test
  - check install
  - deploy

.pytest:
    retry:
        max: 2
        when:
            - runner_system_failure
            - stuck_or_timeout_failure
            - api_failure
    script: .ci/gitlab/script.bash
    environment:
        name: unsafe
    after_script:
      - .ci/gitlab/after_script.bash
    only: ['branches', 'tags', 'triggers', 'merge-requests']
    artifacts:
        name: "$CI_JOB_STAGE-$CI_COMMIT_REF_SLUG"
        expire_in: 3 months
        paths:
            - src/pymortests/testdata/check_results/*/*_changed
            - .coverage
        reports:
            junit: test_results.xml

3.6_numpy:
    extends: .pytest
    image: pymor/testing:3.6
    stage: test
    variables:
        PYMOR_PYTEST_MARKER: "numpy"
        DOCKER_TAG: "3.6"
3.6_None:
    extends: .pytest
    image: pymor/testing:3.6
    stage: test
    variables:
        PYMOR_PYTEST_MARKER: "None"
        DOCKER_TAG: "3.6"
3.6_PIP_ONLY:
    extends: .pytest
    image: pymor/testing:3.6
    stage: test
    variables:
        PYMOR_PYTEST_MARKER: "PIP_ONLY"
        DOCKER_TAG: "3.6"
3.6_MPI:
    extends: .pytest
    image: pymor/testing:3.6
    stage: test
    variables:
        PYMOR_PYTEST_MARKER: "MPI"
        DOCKER_TAG: "3.6"
3.7_None:
    extends: .pytest
    image: pymor/testing:3.7
    stage: test
    variables:
        PYMOR_PYTEST_MARKER: "None"
        DOCKER_TAG: "3.7"
3.7_PIP_ONLY:
    extends: .pytest
    image: pymor/testing:3.7
    stage: test
    variables:
        PYMOR_PYTEST_MARKER: "PIP_ONLY"
        DOCKER_TAG: "3.7"
3.7_MPI:
    extends: .pytest
    image: pymor/testing:3.7
    stage: test
    variables:
        PYMOR_PYTEST_MARKER: "MPI"
        DOCKER_TAG: "3.7"
3.6_None_submit:
    extends: .pytest
    image: pymor/testing:3.6
    stage: deploy
    dependencies:
        - 3.6_None
    environment:
        name: safe
    except:
        - github/PR_.*
    variables:
        PYMOR_PYTEST_MARKER: "None"
        DOCKER_TAG: "3.6"
3.6_PIP_ONLY_submit:
    extends: .pytest
    image: pymor/testing:3.6
    stage: deploy
    dependencies:
        - 3.6_PIP_ONLY
    environment:
        name: safe
    except:
        - github/PR_.*
    variables:
        PYMOR_PYTEST_MARKER: "PIP_ONLY"
        DOCKER_TAG: "3.6"
3.7_None_submit:
    extends: .pytest
    image: pymor/testing:3.7
    stage: deploy
    dependencies:
        - 3.7_None
    environment:
        name: safe
    except:
        - github/PR_.*
    variables:
        PYMOR_PYTEST_MARKER: "None"
        DOCKER_TAG: "3.7"
3.7_PIP_ONLY_submit:
    extends: .pytest
    image: pymor/testing:3.7
    stage: deploy
    dependencies:
        - 3.7_PIP_ONLY
    environment:
        name: safe
    except:
        - github/PR_.*
    variables:
        PYMOR_PYTEST_MARKER: "PIP_ONLY"
        DOCKER_TAG: "3.7"

.docker-in-docker:
    retry:
        max: 2
        when:
            - always
    image: docker:stable
    variables:
        DOCKER_HOST: tcp://docker:2375/
        DOCKER_DRIVER: overlay2
    before_script:
        - apk --update add openssh-client rsync git file bash python3
        - pip3 install jinja2
        - 'export SHARED_PATH="${CI_PROJECT_DIR}/shared"'
        - mkdir -p ${SHARED_PATH}
    services:
        - docker:dind
    environment:
        name: unsafe
debian_stretch_pip:
    extends: .docker-in-docker
    stage: deploy
    script: docker build -f .ci/docker/install_checks/debian_stretch/Dockerfile .

debian_buster_pip:
    extends: .docker-in-docker
    stage: deploy
    script: docker build -f .ci/docker/install_checks/debian_buster/Dockerfile .

debian_testing_pip:
    extends: .docker-in-docker
    stage: deploy
    script: docker build -f .ci/docker/install_checks/debian_testing/Dockerfile .

centos_7_pip:
    extends: .docker-in-docker
    stage: deploy
    script: docker build -f .ci/docker/install_checks/centos_7/Dockerfile .

3.6_wheel:
    extends: .docker-in-docker
    stage: deploy
    only: ['branches', 'tags', 'triggers']
    variables:
        PYVER: "3.6"
        TEST_OS: "debian_stretch debian_buster debian_testing centos_7"
    script: bash .ci/gitlab/wheels.bash
    artifacts:
        paths:
        # cannot use exported var from env here
        - ${CI_PROJECT_DIR}/shared/pymor*manylinux*whl
        expire_in: 1 week

3.7_wheel:
    extends: .docker-in-docker
    stage: deploy
    only: ['branches', 'tags', 'triggers']
    variables:
        PYVER: "3.7"
        TEST_OS: "debian_stretch debian_buster debian_testing centos_7"
    script: bash .ci/gitlab/wheels.bash
    artifacts:
        paths:
        # cannot use exported var from env here
        - ${CI_PROJECT_DIR}/shared/pymor*manylinux*whl
        expire_in: 1 week


# THIS FILE IS AUTOGENERATED -- DO NOT EDIT #
#   Edit and Re-run .ci/gitlab/template.ci.py instead       #
