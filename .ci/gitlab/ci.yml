# THIS FILE IS AUTOGENERATED -- DO NOT EDIT #
#   Edit and Re-run .ci/gitlab/template.ci.py instead       #

stages:
  - sanity
  - test
  - build
  - install_checks
  - deploy

#************ definition of base jobs *********************************************************************************#

.test_base:
    retry:
        max: 2
        when:
            - runner_system_failure
            - api_failure
    tags:
      - autoscaling
    rules:
        - if: $CI_COMMIT_REF_NAME =~ /^staging.*/
          when: never
        - when: on_success
    variables:
        PYPI_MIRROR_TAG: 6d738beebff015c12da613d2c2208d2010b6f234
        CI_IMAGE_TAG: 6d738beebff015c12da613d2c2208d2010b6f234
        PYMOR_HYPOTHESIS_PROFILE: ci
        PYMOR_PYTEST_EXTRA: ""
        PYMOR_CONFIG_DISABLE: "fenics ngsolve scikit_fem dealii dunegdt"
        BINDERIMAGE: ${CI_REGISTRY_IMAGE}/binder:${CI_COMMIT_REF_SLUG}

.pytest:
    extends: .test_base
    tags:
      - long execution time
      - autoscaling
    environment:
        name: unsafe
    stage: test
    after_script:
      - .ci/gitlab/after_script.bash
    cache:
        key: same_db_on_all_runners
        paths:
          - .hypothesis
    artifacts:
        when: always
        name: "$CI_JOB_STAGE-$CI_COMMIT_REF_SLUG"
        expire_in: 3 months
        paths:
            - src/pymortests/testdata/check_results/*/*_changed
            - docs/source/*_extracted.py
            - coverage*
            - memory_usage.txt
            - .hypothesis
            - test_results*.xml


.submit:
    extends: .test_base
    image: zivgitlab.wwu.io/pymor/docker/pymor/ci_sanity:${CI_IMAGE_TAG}
    variables:
        XDG_CACHE_DIR: /tmp
    retry:
        max: 2
        when:
            - always
    environment:
        name: safe
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_REF_NAME =~ /^github.*/
      when: never
    - when: on_success
    stage: deploy
    script: .ci/gitlab/submit.bash

.docker-in-docker:
    tags:
      - docker-in-docker
      - autoscaling
    extends: .test_base
    timeout: 45 minutes
    retry:
        max: 2
        when:
            - runner_system_failure
            - stuck_or_timeout_failure
            - api_failure
            - unknown_failure
            - job_execution_timeout
    
    image: zivgitlab.wwu.io/pymor/docker/pymor/docker-in-docker:2022.1.0@sha256:c912491b287e5e539efc7e160a4196bfef4e3c71934ff70e66afc4da88470254

    variables:
        DOCKER_DRIVER: overlay2
    before_script:
        - 'export SHARED_PATH="${CI_PROJECT_DIR}/shared"'
        - mkdir -p ${SHARED_PATH}
        - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    services:
        - name: zivgitlab.wwu.io/pymor/docker/pymor/docker-in-docker:2022.1.0@sha256:c912491b287e5e539efc7e160a4196bfef4e3c71934ff70e66afc4da88470254
          alias: docker
    environment:
        name: unsafe


# this should ensure binderhubs can still build a runnable image from our repo
.binder:
    extends: .docker-in-docker
    stage: install_checks
    needs: ["ci setup"]
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        USER: juno

.check_wheel:
    extends: .test_base
    stage: install_checks
    timeout: 10 minutes
    dependencies: ["sdist_and_wheel"]
    needs: ["sdist_and_wheel"]
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    services:
      - name: zivgitlab.wwu.io/pymor/docker/pymor/devpi:${PYPI_MIRROR_TAG}
        alias: pymor__devpi
    before_script:
      # bump to our minimal version
      - python3 -m pip install "devpi-client"
      - python3 -m pip install "https://m.devpi.net/fschulze/dev/+f/6ac/e7aaa2d1196f1/devpi_common-3.7.1.dev0-py2.py3-none-any.whl"
      - devpi use http://pymor__devpi:3141/root/public --set-cfg
      - devpi login root --password ''
      - devpi upload --from-dir --formats=* ./dist/*.whl
      - python3 -m pip install pip~=22.0
      - python3 -m pip uninstall -y pymor || true
    # the docker service addressing fails on other runners
    tags: [mike]

.sanity_checks:
    extends: .test_base
    image: zivgitlab.wwu.io/pymor/docker/pymor/ci_sanity:${CI_IMAGE_TAG}
    stage: sanity
#******** end definition of base jobs *********************************************************************************#

# https://docs.gitlab.com/ee/ci/yaml/README.html#workflowrules-templates
include:
  - template: 'Workflows/Branch-Pipelines.gitlab-ci.yml'

#******* sanity stage

ci setup:
    extends: .sanity_checks
    script:
        - ${CI_PROJECT_DIR}/.ci/gitlab/ci_sanity_check.bash "3.8 3.10"

#****** test stage
mpi 3 8:
    extends: .pytest
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        COVERAGE_FILE: coverage_mpi__3.8
        PYMOR_CONFIG_DISABLE: "ngsolve scikit_fem dealii dunegdt"
    retry:
        max: 2
        when: always
    services:
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.8:${CI_IMAGE_TAG}
    script:
        - |
          if [[ "$CI_COMMIT_REF_NAME" == *"github/PR_"* ]]; then
            echo selecting hypothesis profile "ci_pr" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci_pr"
          else
            echo selecting hypothesis profile "ci" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci"
          fi
        - ./.ci/gitlab/test_mpi.bash
mpi 3 10:
    extends: .pytest
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        COVERAGE_FILE: coverage_mpi__3.10
        PYMOR_CONFIG_DISABLE: "ngsolve scikit_fem dealii dunegdt"
    retry:
        max: 2
        when: always
    services:
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.10:${CI_IMAGE_TAG}
    script:
        - |
          if [[ "$CI_COMMIT_REF_NAME" == *"github/PR_"* ]]; then
            echo selecting hypothesis profile "ci_pr" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci_pr"
          else
            echo selecting hypothesis profile "ci" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci"
          fi
        - ./.ci/gitlab/test_mpi.bash
pip_installed 3 8:
    extends: .pytest
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        COVERAGE_FILE: coverage_pip_installed__3.8
    services:
        - name: zivgitlab.wwu.io/pymor/docker/pymor/pypi-mirror_stable_py3.8:${PYPI_MIRROR_TAG}
          alias: pypi_mirror
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.8:${CI_IMAGE_TAG}
    script:
        - |
          if [[ "$CI_COMMIT_REF_NAME" == *"github/PR_"* ]]; then
            echo selecting hypothesis profile "ci_pr" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci_pr"
          else
            echo selecting hypothesis profile "ci" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci"
          fi
        - ./.ci/gitlab/test_pip_installed.bash
pip_installed 3 10:
    extends: .pytest
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        COVERAGE_FILE: coverage_pip_installed__3.10
    services:
        - name: zivgitlab.wwu.io/pymor/docker/pymor/pypi-mirror_stable_py3.10:${PYPI_MIRROR_TAG}
          alias: pypi_mirror
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.10:${CI_IMAGE_TAG}
    script:
        - |
          if [[ "$CI_COMMIT_REF_NAME" == *"github/PR_"* ]]; then
            echo selecting hypothesis profile "ci_pr" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci_pr"
          else
            echo selecting hypothesis profile "ci" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci"
          fi
        - ./.ci/gitlab/test_pip_installed.bash
tutorials 3 8:
    extends: .pytest
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        COVERAGE_FILE: coverage_tutorials__3.8
    services:
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.8:${CI_IMAGE_TAG}
    script:
        - |
          if [[ "$CI_COMMIT_REF_NAME" == *"github/PR_"* ]]; then
            echo selecting hypothesis profile "ci_pr" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci_pr"
          else
            echo selecting hypothesis profile "ci" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci"
          fi
        - ./.ci/gitlab/test_tutorials.bash
tutorials 3 10:
    extends: .pytest
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        COVERAGE_FILE: coverage_tutorials__3.10
    services:
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.10:${CI_IMAGE_TAG}
    script:
        - |
          if [[ "$CI_COMMIT_REF_NAME" == *"github/PR_"* ]]; then
            echo selecting hypothesis profile "ci_pr" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci_pr"
          else
            echo selecting hypothesis profile "ci" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci"
          fi
        - ./.ci/gitlab/test_tutorials.bash
vanilla 3 8:
    extends: .pytest
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        COVERAGE_FILE: coverage_vanilla__3.8
    services:
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.8:${CI_IMAGE_TAG}
    script:
        - |
          if [[ "$CI_COMMIT_REF_NAME" == *"github/PR_"* ]]; then
            echo selecting hypothesis profile "ci_pr" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci_pr"
          else
            echo selecting hypothesis profile "ci" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci"
          fi
        - ./.ci/gitlab/test_vanilla.bash
vanilla 3 10:
    extends: .pytest
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        COVERAGE_FILE: coverage_vanilla__3.10
    services:
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.10:${CI_IMAGE_TAG}
    script:
        - |
          if [[ "$CI_COMMIT_REF_NAME" == *"github/PR_"* ]]; then
            echo selecting hypothesis profile "ci_pr" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci_pr"
          else
            echo selecting hypothesis profile "ci" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci"
          fi
        - ./.ci/gitlab/test_vanilla.bash
oldest 3 8:
    extends: .pytest
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        COVERAGE_FILE: coverage_oldest__3.8
    services:
        - name: zivgitlab.wwu.io/pymor/docker/pymor/pypi-mirror_oldest_py3.8:${PYPI_MIRROR_TAG}
          alias: pypi_mirror
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.8:${CI_IMAGE_TAG}
    script:
        - |
          if [[ "$CI_COMMIT_REF_NAME" == *"github/PR_"* ]]; then
            echo selecting hypothesis profile "ci_pr" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci_pr"
          else
            echo selecting hypothesis profile "ci" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci"
          fi
        - ./.ci/gitlab/test_oldest.bash
cpp_demo 3 8:
    extends: .pytest
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        COVERAGE_FILE: coverage_cpp_demo__3.8
    services:
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.8:${CI_IMAGE_TAG}
    script:
        - |
          if [[ "$CI_COMMIT_REF_NAME" == *"github/PR_"* ]]; then
            echo selecting hypothesis profile "ci_pr" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci_pr"
          else
            echo selecting hypothesis profile "ci" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci"
          fi
        - ./.ci/gitlab/test_cpp_demo.bash
cpp_demo 3 10:
    extends: .pytest
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        COVERAGE_FILE: coverage_cpp_demo__3.10
    services:
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.10:${CI_IMAGE_TAG}
    script:
        - |
          if [[ "$CI_COMMIT_REF_NAME" == *"github/PR_"* ]]; then
            echo selecting hypothesis profile "ci_pr" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci_pr"
          else
            echo selecting hypothesis profile "ci" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci"
          fi
        - ./.ci/gitlab/test_cpp_demo.bash
fenics 3 8:
    extends: .pytest
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        COVERAGE_FILE: coverage_fenics__3.8
        PYMOR_PYTEST_EXTRA: "-m 'not builtin'"
        PYMOR_CONFIG_DISABLE: "ngsolve scikit_fem dealii dunegdt"
        PYMOR_FIXTURES_DISABLE_BUILTIN: "1"
    services:
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.8:${CI_IMAGE_TAG}
    script:
        - |
          if [[ "$CI_COMMIT_REF_NAME" == *"github/PR_"* ]]; then
            echo selecting hypothesis profile "ci_pr" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci_pr"
          else
            echo selecting hypothesis profile "ci" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci"
          fi
        - ./.ci/gitlab/test_fenics.bash
fenics 3 10:
    extends: .pytest
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        COVERAGE_FILE: coverage_fenics__3.10
        PYMOR_PYTEST_EXTRA: "-m 'not builtin'"
        PYMOR_CONFIG_DISABLE: "ngsolve scikit_fem dealii dunegdt"
        PYMOR_FIXTURES_DISABLE_BUILTIN: "1"
    services:
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.10:${CI_IMAGE_TAG}
    script:
        - |
          if [[ "$CI_COMMIT_REF_NAME" == *"github/PR_"* ]]; then
            echo selecting hypothesis profile "ci_pr" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci_pr"
          else
            echo selecting hypothesis profile "ci" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci"
          fi
        - ./.ci/gitlab/test_fenics.bash
ngsolve 3 8:
    extends: .pytest
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        COVERAGE_FILE: coverage_ngsolve__3.8
        PYMOR_PYTEST_EXTRA: "-m 'not builtin'"
        PYMOR_CONFIG_DISABLE: "fenics scikit_fem dealii dunegdt"
        PYMOR_FIXTURES_DISABLE_BUILTIN: "1"
    services:
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.8:${CI_IMAGE_TAG}
    script:
        - |
          if [[ "$CI_COMMIT_REF_NAME" == *"github/PR_"* ]]; then
            echo selecting hypothesis profile "ci_pr" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci_pr"
          else
            echo selecting hypothesis profile "ci" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci"
          fi
        - ./.ci/gitlab/test_ngsolve.bash
ngsolve 3 10:
    extends: .pytest
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        COVERAGE_FILE: coverage_ngsolve__3.10
        PYMOR_PYTEST_EXTRA: "-m 'not builtin'"
        PYMOR_CONFIG_DISABLE: "fenics scikit_fem dealii dunegdt"
        PYMOR_FIXTURES_DISABLE_BUILTIN: "1"
    services:
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.10:${CI_IMAGE_TAG}
    script:
        - |
          if [[ "$CI_COMMIT_REF_NAME" == *"github/PR_"* ]]; then
            echo selecting hypothesis profile "ci_pr" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci_pr"
          else
            echo selecting hypothesis profile "ci" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci"
          fi
        - ./.ci/gitlab/test_ngsolve.bash
dunegdt 3 8:
    extends: .pytest
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        COVERAGE_FILE: coverage_dunegdt__3.8
        PYMOR_PYTEST_EXTRA: "-m 'not builtin'"
        PYMOR_CONFIG_DISABLE: "fenics ngsolve scikit_fem dealii"
        PYMOR_FIXTURES_DISABLE_BUILTIN: "1"
    services:
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.8:${CI_IMAGE_TAG}
    script:
        - |
          if [[ "$CI_COMMIT_REF_NAME" == *"github/PR_"* ]]; then
            echo selecting hypothesis profile "ci_pr" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci_pr"
          else
            echo selecting hypothesis profile "ci" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci"
          fi
        - ./.ci/gitlab/test_dunegdt.bash
dunegdt 3 10:
    extends: .pytest
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        COVERAGE_FILE: coverage_dunegdt__3.10
        PYMOR_PYTEST_EXTRA: "-m 'not builtin'"
        PYMOR_CONFIG_DISABLE: "fenics ngsolve scikit_fem dealii"
        PYMOR_FIXTURES_DISABLE_BUILTIN: "1"
    services:
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.10:${CI_IMAGE_TAG}
    script:
        - |
          if [[ "$CI_COMMIT_REF_NAME" == *"github/PR_"* ]]; then
            echo selecting hypothesis profile "ci_pr" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci_pr"
          else
            echo selecting hypothesis profile "ci" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci"
          fi
        - ./.ci/gitlab/test_dunegdt.bash
scikit_fem 3 8:
    extends: .pytest
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        COVERAGE_FILE: coverage_scikit_fem__3.8
        PYMOR_PYTEST_EXTRA: "-m 'not builtin'"
        PYMOR_CONFIG_DISABLE: "fenics ngsolve dealii dunegdt"
        PYMOR_FIXTURES_DISABLE_BUILTIN: "1"
    services:
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.8:${CI_IMAGE_TAG}
    script:
        - |
          if [[ "$CI_COMMIT_REF_NAME" == *"github/PR_"* ]]; then
            echo selecting hypothesis profile "ci_pr" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci_pr"
          else
            echo selecting hypothesis profile "ci" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci"
          fi
        - ./.ci/gitlab/test_scikit_fem.bash
scikit_fem 3 10:
    extends: .pytest
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    variables:
        COVERAGE_FILE: coverage_scikit_fem__3.10
        PYMOR_PYTEST_EXTRA: "-m 'not builtin'"
        PYMOR_CONFIG_DISABLE: "fenics ngsolve dealii dunegdt"
        PYMOR_FIXTURES_DISABLE_BUILTIN: "1"
    services:
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.10:${CI_IMAGE_TAG}
    script:
        - |
          if [[ "$CI_COMMIT_REF_NAME" == *"github/PR_"* ]]; then
            echo selecting hypothesis profile "ci_pr" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci_pr"
          else
            echo selecting hypothesis profile "ci" for branch $CI_COMMIT_REF_NAME
            export PYMOR_HYPOTHESIS_PROFILE="ci"
          fi
        - ./.ci/gitlab/test_scikit_fem.bash
ci_weekly 3 8:
    extends: .pytest
    timeout: 5h
    variables:
        COVERAGE_FILE: coverage_ci_weekly
    rules:
        - if: $CI_PIPELINE_SOURCE == "schedule"
          when: always
    services:
        - name: zivgitlab.wwu.io/pymor/docker/pymor/pypi-mirror_stable_py3.8:${PYPI_MIRROR_TAG}
          alias: pypi_mirror
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.8:${CI_IMAGE_TAG}
    
    script: ./.ci/gitlab/test_vanilla.bash
ci_weekly 3 10:
    extends: .pytest
    timeout: 5h
    variables:
        COVERAGE_FILE: coverage_ci_weekly
    rules:
        - if: $CI_PIPELINE_SOURCE == "schedule"
          when: always
    services:
        - name: zivgitlab.wwu.io/pymor/docker/pymor/pypi-mirror_stable_py3.10:${PYPI_MIRROR_TAG}
          alias: pypi_mirror
    image: zivgitlab.wwu.io/pymor/docker/pymor/testing_py3.10:${CI_IMAGE_TAG}
    
    script: ./.ci/gitlab/test_vanilla.bash

submit coverage:
    extends: .submit
    artifacts:
        when: always
        name: "coverage_reports"
        paths:
            - reports/
    dependencies:
        - mpi 3 8
        - mpi 3 10
        - tutorials 3 8
        - tutorials 3 10
        - vanilla 3 8
        - vanilla 3 10
        - oldest 3 8
        - fenics 3 8
        - fenics 3 10
        - ngsolve 3 8
        - ngsolve 3 10
        - dunegdt 3 8
        - dunegdt 3 10
        - scikit_fem 3 8
        - scikit_fem 3 10

coverage html:
    extends: .submit
    needs: ["submit coverage"]
    dependencies: ["submit coverage"]
    artifacts:
        name: "coverage_html"
        paths:
            - coverage_html
    before_script:
        - apk add py3-coverage
    script:
        - coverage combine reports/coverage*
        - coverage html --directory coverage_html
submit ci_weekly 3 8:
    extends: .submit
    rules:
        - if: $CI_PIPELINE_SOURCE == "schedule"
          when: always
    dependencies:
        - ci_weekly 3 8
    needs: ["ci_weekly 3 8"]
submit ci_weekly 3 10:
    extends: .submit
    rules:
        - if: $CI_PIPELINE_SOURCE == "schedule"
          when: always
    dependencies:
        - ci_weekly 3 10
    needs: ["ci_weekly 3 10"]



from source 1/2:
    extends: .test_base
    tags: [mike]
    services:
        - name: zivgitlab.wwu.io/pymor/docker/pymor/pypi-mirror_stable_py3.10:${PYPI_MIRROR_TAG}
          alias: pypi_mirror
    needs: ["ci setup"]
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    stage: install_checks
    image: zivgitlab.wwu.io/pymor/docker/pymor/deploy_checks_fedora:${CI_IMAGE_TAG}
    script: ./.ci/gitlab/install_checks/fedora/check.bash

from source 2/2:
    extends: .test_base
    tags: [mike]
    services:
        - name: zivgitlab.wwu.io/pymor/docker/pymor/pypi-mirror_stable_py3.9:${PYPI_MIRROR_TAG}
          alias: pypi_mirror
    needs: ["ci setup"]
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    stage: install_checks
    image: zivgitlab.wwu.io/pymor/docker/pymor/deploy_checks_debian-bullseye:${CI_IMAGE_TAG}
    script: ./.ci/gitlab/install_checks/debian-bullseye/check.bash


binder base image:
    extends: .binder
    stage: build
    script:
        - docker build --build-arg CI_IMAGE_TAG=${CI_IMAGE_TAG} -t ${BINDERIMAGE} -f .ci/gitlab/Dockerfile.binder.base .
        - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
        - docker run ${BINDERIMAGE} ipython -c "from pymor.basic import *"
        - docker push ${BINDERIMAGE}

local docker:
    extends: .binder
    script:
        - make docker_image
        - make DOCKER_CMD="ipython -c 'from pymor.basic import *'" docker_exec


trigger_binder 1/3:
    extends: .test_base
    stage: deploy
    image: harbor.uni-muenster.de/proxy-docker/library/alpine:3.16
    rules:
        - if: $CI_COMMIT_REF_NAME == "main"
          when: on_success
        - if: $CI_COMMIT_TAG != null
          when: on_success
    before_script:
        - apk --update add bash py3-pip
        - pip3 install requests
    script:
        - python3 .ci/gitlab/trigger_binder.py "https://gke.mybinder.org/build/gh/pymor/pymor/${CI_COMMIT_REF}"

trigger_binder 2/3:
    extends: .test_base
    stage: deploy
    image: harbor.uni-muenster.de/proxy-docker/library/alpine:3.16
    rules:
        - if: $CI_COMMIT_REF_NAME == "main"
          when: on_success
        - if: $CI_COMMIT_TAG != null
          when: on_success
    before_script:
        - apk --update add bash py3-pip
        - pip3 install requests
    script:
        - python3 .ci/gitlab/trigger_binder.py "https://ovh.mybinder.org/build/gh/pymor/pymor/${CI_COMMIT_REF}"

trigger_binder 3/3:
    extends: .test_base
    stage: deploy
    image: harbor.uni-muenster.de/proxy-docker/library/alpine:3.16
    rules:
        - if: $CI_COMMIT_REF_NAME == "main"
          when: on_success
        - if: $CI_COMMIT_TAG != null
          when: on_success
    before_script:
        - apk --update add bash py3-pip
        - pip3 install requests
    script:
        - python3 .ci/gitlab/trigger_binder.py "https://gesis.mybinder.org/build/gh/pymor/pymor/${CI_COMMIT_REF}"


sdist_and_wheel:
    extends: .sanity_checks
    stage: build
    needs: ["ci setup"]
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - when: on_success
    artifacts:
        paths:
        - dist/pymor*.whl
        - dist/pymor*.tar.gz
        expire_in: 1 week
    script: python3 -m build

pypi:
    extends: .test_base
    image: harbor.uni-muenster.de/proxy-docker/library/alpine:3.16
    stage: deploy
    needs:
    dependencies:
      - sdist_and_wheel
    rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
      when: never
    - if: $CI_COMMIT_REF_NAME =~ /^github.*/
      when: never
    - when: on_success
    variables:
        ARCHIVE_DIR: pyMOR_wheels-${CI_COMMIT_REF_NAME}
    artifacts:
        paths:
         - ${CI_PROJECT_DIR}/${ARCHIVE_DIR}/pymor*whl
         - ${CI_PROJECT_DIR}/${ARCHIVE_DIR}/pymor*tar.gz
        expire_in: 6 months
        name: pymor-wheels
    before_script:
        - apk add py3-pip twine bash
    script:
        - ${CI_PROJECT_DIR}/.ci/gitlab/pypi_deploy.bash
    environment:
        name: safe


from wheel 1/2:
    extends: .check_wheel
    image: zivgitlab.wwu.io/pymor/docker/pymor/deploy_checks_fedora:${CI_IMAGE_TAG}
    script:
      - echo "Testing wheel install on fedora with Python 3.10"
      - python3 -m pip freeze --all
      - devpi install pymor[full]

from wheel 2/2:
    extends: .check_wheel
    image: zivgitlab.wwu.io/pymor/docker/pymor/deploy_checks_debian-bullseye:${CI_IMAGE_TAG}
    script:
      - echo "Testing wheel install on debian-bullseye with Python 3.9"
      - python3 -m pip freeze --all
      - devpi install pymor[full]

docs build 3 8:
    extends: .test_base
    tags: [mike]
    rules:
        - if: $CI_PIPELINE_SOURCE == "schedule"
          when: never
        - when: on_success
    services:
        - name: zivgitlab.wwu.io/pymor/docker/pymor/pypi-mirror_stable_py3.8:${PYPI_MIRROR_TAG}
          alias: pypi_mirror
    image: zivgitlab.wwu.io/pymor/docker/pymor/jupyter_py3.8:${CI_IMAGE_TAG}
    script:
        - ${CI_PROJECT_DIR}/.ci/gitlab/test_docs.bash
    stage: build
    needs: ["ci setup"]
    artifacts:
        paths:
            - docs/_build/html
            - docs/error.log

docs build 3 10:
    extends: .test_base
    tags: [mike]
    rules:
        - if: $CI_PIPELINE_SOURCE == "schedule"
          when: never
        - when: on_success
    services:
        - name: zivgitlab.wwu.io/pymor/docker/pymor/pypi-mirror_stable_py3.10:${PYPI_MIRROR_TAG}
          alias: pypi_mirror
    image: zivgitlab.wwu.io/pymor/docker/pymor/jupyter_py3.10:${CI_IMAGE_TAG}
    script:
        - ${CI_PROJECT_DIR}/.ci/gitlab/test_docs.bash
    stage: build
    needs: ["ci setup"]
    artifacts:
        paths:
            - docs/_build/html
            - docs/error.log


docs:
    extends: .docker-in-docker
    # makes sure this doesn't land on the test runner
    tags: [mike]
    image: harbor.uni-muenster.de/proxy-docker/library/alpine:3.16
    stage: deploy
    resource_group: docs_deploy
    needs: ["docs build 3 10", "binder base image"]
    dependencies: ["docs build 3 10", "binder base image"]
    before_script:
        - apk --update add make py3-pip bash py3-ruamel.yaml.clib
        - pip3 install jinja2 jupyter-repo2docker
    script:
        - ${CI_PROJECT_DIR}/.ci/gitlab/deploy_docs.bash
    rules:
        - if: $CI_PIPELINE_SOURCE == "schedule"
          when: never
        - if: $CI_COMMIT_REF_NAME =~ /^github\/PR_.*/
          when: never
        - when: on_success
    environment:
        name: safe

# THIS FILE IS AUTOGENERATED -- DO NOT EDIT #
#   Edit and Re-run .ci/gitlab/template.ci.py instead       #
